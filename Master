#This is a webscraper designed to look at the newest listing on craigslist free section and send a message to the email of your choice
#you can change the craigslist page to most anything in "for sale" and it should work
# in order to send to a gmail account youll have to enable less secure app youll be fine but always be carfull
import smtplib
import requests
#universal place holder of last item
last_item = "nothing"
this_list =[]
def startUp():
	print("Duncan's Craigslist Scraper")
	print("                  ") 
        print("      vvvvvvv  /|__/|")
        print("         I   /O,O   |")
        print("         I /_____   |     /|/|")
        print("        J|/^ ^ ^ \  |    /00  |    _//|")
        print("         |^ ^ ^ ^ |W|   |/^^\ |   /oo |")
        print("          \m___m__|_|    \m_m_|   \mm_|")
	print("Hello Welcome to Duncan's Craigslist Python Scraper")
	print("Please put all the keywords you are looking for in all lowercase seperated by spaces")
	global this_list
	this_list = raw_input("Enter Search terms: ")
	this_list = this_list.split()
   		


#main Function
def runing():
	global this_list
	global last_item
	alert_trigger = 0
	#Welcome screen and  prompt
	print("Running Scrape...")
	#Pulls the current website info
	page = requests.get("https://raleigh.craigslist.org/d/free-stuff/search/zip")
	#imports libraries and parse data to readable
	from bs4 import BeautifulSoup
	soup = BeautifulSoup(page.content, 'html.parser')
	
	#Search html for last Submitted item
	current_item = (soup.find_all(class_='result-title hdrlnk')[0].get_text())
	
	
	#Removes and case sensitivity/ set place holder to compare
	current_item = current_item.lower()
	


	#checks and compares against keyword from "THIS_LIST"
	if current_item != last_item:
		#sets alert email back to zero to no send
	
		print("NEW ITEM!: " + current_item)
		for x in this_list:
			if (current_item.find(x) == -1):
				print(x + ": No")
				last_item = current_item
			else:
				print(x + ": Yes")
				last_item = current_item
				alert_trigger = 1
	else:
		print("nothing new")

	if alert_trigger > 0:
		alert(current_item)
	else:
	#Start again
		runing()

def alert(message_item):
	TO = 'your email here@ gmail.com'
	SUBJECT = 'Craigs List Alert'
	TEXT = message_item

	# Gmail Sign In
	gmail_sender = 'your email here@ gmail.com'
	gmail_passwd = 'your password here'
	
	server = smtplib.SMTP('smtp.gmail.com', 587)
	server.ehlo()
	server.starttls()
	server.login(gmail_sender, gmail_passwd)

	BODY = '\r\n'.join(['To: %s' % TO,
                    'From: %s' % gmail_sender,
                    'Subject: %s' % SUBJECT,
                    '', TEXT])

	try:
		server.sendmail(gmail_sender, [TO], BODY)
		print ('email sent')
	except:
		print ('error sending mail')

	server.quit()
	runing()




#Start 
startUp()
runing()
#thing = (soup.find(class_='result-title hdrlnk'))
#print(thing)
